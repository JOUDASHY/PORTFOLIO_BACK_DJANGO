# .github/workflows/deploy-backend.yml
name: Deploy Django Backend

on:
  push:
    branches:
      - main  # D√©clenchement du workflow sur push dans la branche main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Server
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        # D√©marrer l'agent SSH et ajouter la cl√© priv√©e
        eval "$(ssh-agent -s)"
        ssh-add - <<< "$SSH_PRIVATE_KEY"

        # Connexion SSH et d√©ploiement
        ssh -o StrictHostKeyChecking=no root@89.116.111.200 << 'EOF'
          set -e

          cd /var/www/PORTFOLIO_BACK_DJANGO

          echo "üì• Pull latest code"
          git pull origin main

          echo "üê≥ Build Docker image"
          docker build -t portfolio-backend .

          echo "üõë Stop & remove old container"
          docker stop portfolio-backend-container || true
          docker rm   portfolio-backend-container || true

          echo "üöÄ Run new container"
          docker run -d \
            --name portfolio-backend-container \
            --env-file .env \
            -p 8000:8000 \
            --restart unless-stopped \
            portfolio-backend:latest

          echo "‚úÖ D√©ploiement termin√©"
        EOF
